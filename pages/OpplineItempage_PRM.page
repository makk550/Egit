<apex:page id="opplipage" standardcontroller="OpportunityLineItem" extensions="OppLineItemcontroller_PRM,OppLineItemRemoteActions_PRM" sidebar="false"> 
 
     <LINK href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css"/>
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" />
     <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"/>
     <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/themes/smoothness/jquery-ui.css"/>
   
     
    
     <style>
             .customPopup1      {
                                background-color: #dbeefd;opacity: .95; -moz-opacity: .95; filter:alpha(opacity=95);  position: absolute; left:0;top:0; width:100%; height:100%; z-index: 3;
                                }
     
         .customPopup            {
                                background-color: rgba(255,255,255,1);
                                left: 55%;
                                padding:10px;
                                position: absolute;
                                z-index: 9999;
                                width: 280px;
                                Height: 130px;
                                margin-left: -250px;
                                top:210px;
                                }

                                
            .displayNone { 
                display:none; 
            }
            .displayBlock {
                display:block;
            }
            .ui-autocomplete-loading { 
                <!--background: white url(/img/loading32.gif) right center no-repeat; -->            
                background-size:15px 15px; 
            }
            .placeHolder {
                font-style: italic;
                overflow-y: scroll;
                /* prevent horizontal scrollbar */
                overflow-x: hidden;
                /* add padding to account for vertical scrollbar */
                padding-right: 20px;
            }
            .ui-autocomplete {
                max-height: 200px;
                overflow-y: scroll;
                /* prevent horizontal scrollbar */
                overflow-x: hidden;
                /* add padding to account for vertical scrollbar */
                padding-right: 20px;
            }            
            .ui-widget-content {
                border:none
            }
                                             
     </style> 
  
    <script type="text/javascript">
    
    function disableEnterKey(evt) { 
         var evt = (evt) ? evt : ((event) ? event : null); 
         var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null); 
         if ((evt.keyCode == 13) && (node.type=="text"))  {return false;} 
    } 

document.onkeypress = disableEnterKey;
  
    
        function setFocusOnLoad() {}

        function selectAllCheckboxes(obj,receivedInputID){
            var inputCheckBox = document.getElementsByTagName("input");
            for(var i=0; i<inputCheckBox.length; i++){
                if(inputCheckBox[i].id.indexOf(receivedInputID)!=-1){
                    inputCheckBox[i].checked = obj.checked;
                }
            }
        }
        
        function jsAdd(){
        
        console.debug("JS Script invoked");
            AddProductFunction();
            console.debug("Apex Method invoked");
        
        }
        
        
        function selectAllProducts(selectAllCheckbox,checkboxID){
            var inputCheckBox = document.getElementsByTagName("input");                  
            for(var i=0; i<inputCheckBox.length; i++){          
                if(inputCheckBox[i].id.indexOf(checkboxID)!=-1){                                     
                    inputCheckBox[i].checked = selectAllCheckbox.checked;
                }
            }
        }
        
       //MANAR08 - popup logic starts

      function checkBeforeReturn(){
         $(".ui-dialog-titlebar").hide(); 
         CheckandReturn();
       }       
       
       function openPopUp(){ 
            $(".ui-dialog-titlebar").hide();           
            OppLineItemRemoteActions_PRM.noPgmExists('{!$CurrentPage.parameters.oppid}',
                function(result,event){
                        if(result){
                            $("#noPgmPopup").dialog("open");
                            if('{!$CurrentPage.parameters.recType}' != 'New Opportunity'){
                                OppLineItemRemoteActions_PRM.updateRecordTypetoNewOpp('{!$CurrentPage.parameters.oppid}',function(result,event){});
                            }
                        }
                        else{
                            OppLineItemRemoteActions_PRM.fetchSepPgmProdList('{!$CurrentPage.parameters.oppid}',
                                function(result,event){
                                    console.debug('fetchSepPgmProdList event:'+event.status+'event message:'+event.message);
                                    if(result.length > 0)   {
                                        $("#sepPgmPopup").dialog("open");                         
                                        $.each(result,function(index,value){
                                                $("#sepPgmList").append(value+"<br/>");             
                                            }                       
                                        );                      
                                    }
                                    else{
                                        if('{!$CurrentPage.parameters.recType}' == 'New Opportunity'){
                                            //$("#popupContent2").dialog("open");
                                            OppLineItemRemoteActions_PRM.updateRecordTypetoDealReg('{!$CurrentPage.parameters.oppid}',function(result,event){
                                                console.debug('updateRecordTypetoDealReg event status:'+event.status+'event message:'+event.message);
                                                if(result == 'true'){
                                                    goToDetailPage();
                                                }
                                                else{
                                                    console.debug('result in sepPgmPopup 1 :'+result);
                                                    var errorDiv = '<div class=\'message errorM3\' role=\'alert\'> <table border=\'0\' cellpadding=\'0\' cellspacing=\'0\' class=\'messageTable\' style=\'padding:0px;margin:0px;\'>' + 
                                                                  '<tbody> <tr valign=\'top\'> <td> <img alt=\'ERROR\' class=\'msgIcon\' src=\'/s.gif\' title=\'ERROR\'> </td> <td class=\'messageCell\'> <div class=\'messageText\'>' +
                                                                  '<span style=\'color:#cc0000\'><h4>Errors</h4></span><br></div></td> </tr><tr><td></td> <td><span><ul style=\'padding-left:10px;padding-top:0px;margin:0px\'>' + 
                                                                  '<li style=\'padding-top:5px\'>' + result +'</li> </ul> </span> </td> </tr> </tbody> </table> </div>';
                                                   $("[id = 'opplipage:form1:ReturnErrors']").append(errorDiv);  
                                                    
                                                }
                                            });
                                        }
                                        else{
                                            OppLineItemRemoteActions_PRM.sendEmailForMultiplePrograms('{!$CurrentPage.parameters.oppid}',function(result,event){});
                                            goToDetailPage();
                                        }
                                    }
                                }
                            );                      
                        } //end of else     
                }//end of function(result,event)
            );
       }
       
       $(function() {  
       
            $("#errorPopup").dialog({
                autoOpen: false,
                modal: true,
                buttons : {
                    'Ok': function(){
                        $("#errorPopup").dialog('close');
                        goToDetailPage();
                    }
                }               
            });         
      
            $("#noPgmPopup").dialog({
                autoOpen: false,
                modal: true,
                buttons : {
                    'Ok': function(){
                        $("#noPgmPopup").dialog('close');
                        goToDetailPage();
                    }
                }               
            });
                   
            $("#sepPgmPopup").dialog({        
                autoOpen: false,
                modal: true,
                buttons : {
                    'Yes': function(){
                        OppLineItemRemoteActions_PRM.executeOptoutFunc('{!$CurrentPage.parameters.oppid}',
                            function(result,event){
                                    $("#sepPgmPopup").dialog('close');
                                    //$("#popupContent2").dialog('open');
                                    if('{!$CurrentPage.parameters.recType}' == 'New Opportunity'){
                                        //$("#popupContent2").dialog("open");
                                        OppLineItemRemoteActions_PRM.updateRecordTypetoDealReg('{!$CurrentPage.parameters.oppid}',function(result,event){
                                            if(result == 'true'){
                                                goToDetailPage();
                                            }
                                            else{
                                                   console.debug('result in sepPgmPopup 2 :'+result);
                                                   var errorDiv = '<div class=\'message errorM3\' role=\'alert\'> <table border=\'0\' cellpadding=\'0\' cellspacing=\'0\' class=\'messageTable\' style=\'padding:0px;margin:0px;\'>' + 
                                                                  '<tbody> <tr valign=\'top\'> <td> <img alt=\'ERROR\' class=\'msgIcon\' src=\'/s.gif\' title=\'ERROR\'> </td> <td class=\'messageCell\'> <div class=\'messageText\'>' +
                                                                  '<span style=\'color:#cc0000\'><h4>Errors</h4></span><br></div></td> </tr><tr><td></td> <td><span><ul style=\'padding-left:10px;padding-top:0px;margin:0px\'>' + 
                                                                  '<li style=\'padding-top:5px\'>' + result +'</li> </ul> </span> </td> </tr> </tbody> </table> </div>';
                                                   $("[id = 'opplipage:form1:ReturnErrors']").append(errorDiv);
                                            }                                      
                                        });
                                   }
                                   else{
                                        OppLineItemRemoteActions_PRM.sendEmailForMultiplePrograms('{!$CurrentPage.parameters.oppid}',function(result,event){});
                                        goToDetailPage(); 
                                   }                                                                  
                            }                       
                        );
                    }, 
                    'No': function(){
                        $("#sepPgmPopup").dialog('close');
                        goToDetailPage();
                    }
                }               
                           
            });      
            /*
             $("#popupContent2").dialog({       
                autoOpen: false,
                modal: true,
                buttons : {
                    'Yes': function(){  
                        OppLineItemRemoteActions_PRM.updateRecordTypetoDealReg('{!$CurrentPage.parameters.oppid}',
                            function(result,event){
                                console.debug('res:'+result);
                                    console.debug('event status:'+event.status); 
                                    $("#popupContent2").dialog('close');
                                    $("#popupContent3").dialog('open');    
                            }
                        );
                    }, 
                    'No': function(){
                        $("#popupContent2").dialog('close');
                        goToDetailPage();
                    }
                }
            });
            
            $("#popupContent3").dialog({        
                autoOpen: false,
                modal: true,
                buttons : {
                    'Ok': function(){
                        $("#popupContent3").dialog('close');
                        goToDetailPage();
                    }
                }
            }); */
            
           $("#CheckforUnsavedData").dialog({        
                autoOpen: false,
                modal: true,
                buttons : {
                    'Ok': function(){
                        $("#CheckforUnsavedData").dialog('close');
                    }
                }
            });            
            
        }); 
        
        //MANAR08 - popup logic ends

    </script>

    <apex:form id="form1" >
     
    <apex:sectionHeader subtitle="{!oppName}" title="Add/Edit Products" rendered="{!isRenewal}"/>
    <apex:outputpanel rendered="{!isRenewal}">
    <apex:outputLink value="/{!oppId}" >Return to Opportunity </apex:outputLink>
  
   
        <apex:pageBlock id="pb1">
        
            <apex:pageMessages id="errorBlock"/> 
           
                        
           <apex:pageBlockSection id="pbs1" title="Renewal Details">
                <apex:inputField value="{!OpportunityLineItem.Term_Month__c }" id="newdealterm" required="true" />
                <apex:inputField value="{!OpportunityLineItem.Original_CV__c}" id="origcv" />
                <apex:inputField value="{!OpportunityLineItem.Original_Deal_Term_Months__c}" id="origdealterm" />
                <!-- <apex:inputField value="{!OpportunityLineItem.Comfort_Term__c}" id="comfortterm" /> -->
                <apex:inputField value="{!OpportunityLineItem.Original_Contract_IDs__c}" id="origcontractids"/>
                <!-- <apex:inputField value="{!OpportunityLineItem.Renewal_Gap_Reason_Codes__c}" id="renewalgap"/> -->
                <apex:inputField value="{!OpportunityLineItem.Renewal_Quota_CV__c}" id="renquota" />
                <apex:pageblocksectionitem >
                    <apex:outputlabel for="renbustype" value="{!$ObjectType.OpportunityLineItem.fields.Business_Type__c.label}" />
                    <apex:outputPanel StyleClass="requiredInput" layout="block">
                    <div class="requiredBlock"></div>
                    <apex:selectList value="{!bustypeval}" id="renbustype" size="1" required="true">   
                        <apex:selectOptions value="{!selbustype}"/>
                    </apex:selectList>
                    </apex:outputPanel>
                </apex:pageblocksectionitem>
                <apex:inputField value="{!OpportunityLineItem.Quote_Number__c}" id="quoteno"/>
                <apex:inputField value="{!OpportunityLineItem.Business_Partner_ID__c}" id="busspartner"/>
                <apex:inputField value="{!OpportunityLineItem.Contract_Number__c}" id="contractno" />
            </apex:pageBlockSection>
            
                <apex:pageBlockSection id="pbs3" title="Details" rendered="{!isRenewal}">
                
                <apex:pageBlockTable id="pbt2" value="{!lst_ren}" var="ren" rendered="{!isRenewal}">
                    <apex:column headervalue="Product Family">
                        <apex:selectList disabled="{!ren.isFamilyDisabled}" value="{!ren.strfamily}" id="ren_fam" size="1" onchange="getbu(this.value,'{!ren.position}');">   
                            <apex:selectOptions value="{!selfamily}"/>
                        </apex:selectList>
                        <apex:actionFunction name="getbu" action="{!fetchrenewalbu}" rerender="pbt2">
                            <apex:param name="familyvalue" value="" assignTo="{!renfamily}" />
                            <apex:param name="positionvalue" value="" assignTo="{!renpos}" />
                        </apex:actionFunction>
                    </apex:column>
                    <apex:column headervalue="Business Unit">
                        <apex:selectList disabled="{!ren.isBUDisabled}" value="{!ren.strbu}" id="ren_bu" size="1" onchange="getprds(this.value,'{!ren.position}','{!ren.strfamily}');">   
                            <apex:selectOptions value="{!ren.selrenbu}"/>
                        </apex:selectList>
                        <apex:actionFunction name="getprds" action="{!fetchproducts}" rerender="pbt2">
                            <apex:param name="buvalue" value="" assignTo="{!bu_value}" />
                            <apex:param name="positionvalue" value="" assignTo="{!pos}" />
                            <apex:param name="familyvalue" value="" assignTo="{!prdfamily}" />
                        </apex:actionFunction>
                    </apex:column>
                    <apex:column headervalue="Product">
                        <apex:selectList disabled="{!ren.isPrdDisabled}" value="{!ren.strproduct}" id="ren_prd" size="1" >   
                            <apex:selectOptions value="{!ren.selproduct}"/>
                        </apex:selectList>
                    </apex:column>
                    
                    <apex:column >
                    <apex:facet name="header">
                        {!$ObjectType.OpportunityLineItem.fields.UnitPrice.label}
                        </apex:facet>
                        <apex:inputField value="{!ren.oppli.UnitPrice}" id="ren_salesprice" />
                    </apex:column>
                    
                    <apex:column >
                    <apex:facet name="header">
                        {!$ObjectType.OpportunityLineItem.fields.Stretch__c.label}
                        </apex:facet>
                        <apex:inputField value="{!ren.oppli.Stretch__c}" id="ren_stretch" />
                    </apex:column> 
                    
                    <apex:column >
                    <apex:facet name="header">
                        {!$ObjectType.OpportunityLineItem.fields.Original_Expiration_Date__c.label}
                        </apex:facet>
                        <apex:inputField value="{!ren.oppli.Original_Expiration_Date__c}" id="ren_exp" />   
                    </apex:column>
                   <!-- <apex:column >
                    <apex:facet name="header">
                        {!$ObjectType.OpportunityLineItem.fields.Original_Expiration_Quarter__c.label}
                        </apex:facet>
                        <apex:outputField value="{!ren.oppli.Original_Expiration_Quarter__c}" id="ren_exp_qtr" />
                    </apex:column>
                     <apex:column >
                    <apex:facet name="header">
                        {!$ObjectType.OpportunityLineItem.fields.Original_Expiration_Year__c.label}
                        </apex:facet>
                        <apex:outputField value="{!ren.oppli.Original_Expiration_Year__c}" id="ren_exp_yr" />  
                    </apex:column>-->
                </apex:pageBlockTable><br/>
                <apex:commandbutton value="Add More" action="{!addmore_ren}" rerender="pbt2" rendered="{!isRenewal}" />
            </apex:pageBlockSection>
            <apex:pageBlockButtons location="top" >
             <apex:actionStatus id="myStatus">
                          <apex:facet name="start">
                               <apex:outputPanel >
                                                                          
                                     <div style="background-color: #dbeefd; opacity: .80; -moz-opacity: 0.80; filter:alpha(opacity=80); position: absolute; left:0;top:0; width:100%; height:100%; z-index: 3;"><apex:image value="/img/loading32.gif" style="height: 20px; position: absolute; left:50%;top:50%;"/></div>
                                 </apex:outputPanel>
                             </apex:facet>
                            <apex:facet name="stop"> 
                            <apex:outputPanel >
                            <apex:commandButton value="Save" action="{!saveproducts}" />
                            <apex:commandButton value="Cancel" action="{!cancel}" />
                            </apex:outputPanel>
                </apex:facet>
             
            </apex:actionStatus>   
            </apex:pageBlockButtons>
            
        </apex:pageBlock>
  </apex:outputpanel>

  <apex:outputPanel rendered="{!isProduct}" >
   <apex:pageMessages id="ReturnErrors"/>
     
<table style="height=200%;width=100%;" >
<tr>
<td  width="90%"><font size="4"><b>Find Products</b></font></td>
<td  width="5%"><apex:commandbutton value="Return to Opportunity"  Style="align:right;width:150px;height:25px;font-size:13px;" status="msg_refresh1" onComplete="checkBeforeReturn();return false;" /></td>
<td  width="5%"><apex:commandbutton value="Cancel"  Style="align:right;width:60px;height:25px;font-size:13px;" action="{!cancel}" /></td>
</tr>
</table>
 <apex:pageBlock >
  
      <apex:actionStatus id="msg_refresh1" stopText="">
                 <apex:facet name="start">
                      <apex:outputPanel >
                            <div style="background-color: #dbeefd; opacity: .80; -moz-opacity: 0.80; filter:alpha(opacity=80); position: absolute; left:0;top:0; width:100%; height:100%; z-index: 4;"><apex:image value="/img/loading32.gif" style="height: 40px; position: relative; left:750px;top:250px; z-index: 4;"/></div>
                        </apex:outputPanel>
                    </apex:facet>
       </apex:actionStatus>
          
       <apex:outputPanel >
    
            <table title="Find Products">
                    
            <tr>
                <div>
                     <td colspan="3"></td>
                    <td><div style="position:relative;left:30px;"><apex:outputLabel id="productName" value="Enter Product detail"/></div></td>
                    <td><div style="position:relative;left:40px;"> 
    
                     <apex:outputPanel >
                         <apex:inputText id="ProductStr" value="{!searchString}" disabled="{!disableTypeAhead}" >
                            <apex:actionsupport event="onmouseout" action="{!SetBU}" rerender="BU,spg" status="msg_refresh1"/>                         
                         </apex:inputText>
                         <apex:inputHidden id="productId" value="{!selectedproduct}" />
                     </apex:outputPanel>
           
                     <apex:actionFunction name="refreshSelectedProducts" action="{!checkBeforeRefreshProductTable}" rerender="popup,script,SearchResultsSection,AddButton,BU" >
            
                     </apex:actionFunction> </div>
                    </td>
                </div>
        <td>
                 <input type="hidden" value="{!productid}" Name="productId" id="productId" />     
                    <input type="hidden" value="{!productName}" Name="productName" id="productName" />    </td>
             
               
                    <td><div style="position:relative;left:90px;"><apex:outputLabel value="Business Unit"/></div></td>
                    
                    <td><apex:actionregion ><div style="position:relative;left:100px;"><apex:outputpanel id="BUpanel">
                    <apex:selectList id="BU" Style="width : 200px" value="{!selectedBU}" size="1" disabled="{!disableBU}" >
                            <apex:selectOptions value="{!BUs}"/>
                            <apex:actionsupport event="onchange" action="{!getproductgroup}" rerender="script,spg,ProductStr,searchButton" status="msg_refresh1">  
                            </apex:actionsupport>
                        </apex:selectList></apex:outputpanel></div></apex:actionregion></td>
                    
                    <td><div style="position:relative;left:150px;"><apex:outputLabel value="Product" /></div></td>
                    <td><div style="position:relative;left:165px;">
                    <apex:selectList Style="width :200px" size="1" value="{!selectedPG}" id="spg" disabled="{!PGs.size<=0}">
                            <apex:selectOptions value="{!PGs}"/>
                            <apex:actionSupport event="onchange" action="{!checkBeforeSearchByProductGroup}" rerender="popup,script,spg,BU,ProductStr,SearchResultsSection,AddButton,SearchErrors,searchButton" status="msg_refresh1" />
                    </apex:selectList>
                        </div></td>
              
              </tr>
              
              </table>
     
            <apex:outputPanel id="script">
            <script type="text/javascript">
                
                           
                var PLACEHOLDER = 'Enter Product detail'; 
                var productList;
                var queryTerm;
        
                
                $('[id$=ProductStr]').autocomplete({
                    
                    minLength: 2,
                    
                    source: function(request, response) {
                                queryTerm = request.term;
                                OppLineItemcontroller_PRM.findSearchResult(request.term,'{!$CurrentPage.parameters.oppid}', function(result, event){
                                    if(event.type == 'exception') {
                                          alert(event.message);
                                    } else {
                                         productList = result;
                                         response(productList);
                                    }
                                });
                           },
                    focus: function( event, ui ) {
                            $('[id$=ProductStr]').val( ui.item.Name );
                            return false;
                            },
                    select: function( event, ui ) {
        
        
                                $('[id$=ProductStr]').val( ui.item.Name );
                                $('[id$=productId]').val( ui.item.Id );
        
                                refreshSelectedProducts();
                                
                                return false;
                            },
                 })
                 .data( "ui-autocomplete" )._renderItem = function( ul, item ) {
                    var entry = "<a>" + item.Name;
                   
                    entry = entry + "</a>";
                    entry = entry.replace(queryTerm, "<b>" + queryTerm + "</b>");
                    return $( "<li></li>" )
                        .data( "item.autocomplete", item )
                        .append( entry )
                        .appendTo( ul );
                };
                    
                // Add or remove placeholder values
                $('[id$=ProductStr]').val(PLACEHOLDER);
                $('[id$=ProductStr]').on("focus",  function(event){
                    $tgt = $(event.target);
                    if($tgt.val() === PLACEHOLDER ){
                        $tgt.val('');
                        $tgt.removeClass('placeHolder');
                    }
                });
                $('[id$=ProductStr]').on( "blur",  function(event){
                    $tgt = $(event.target);
                    if($tgt.val() === '' ){
                        $tgt.val(PLACEHOLDER);
                        $tgt.addClass('placeHolder');
                    }
                }); 
                
                
                
                                    
        </script>    
        </apex:outputPanel>         
       </apex:outputpanel>  
    
    <apex:pageMessages id="SearchErrors"/>  
    
         <apex:pageBlockButtons location="bottom">
        
          <apex:outputPanel id="SearchButtons">
             <apex:commandbutton value="Search"  Style="width:45px;" action="{!checkBeforeSearch}" id="searchButton"  status="msg_refresh1" reRender="popup,SearchResultsSection,AddButton,SearchResults" disabled="{!disableSearch}" />
             <apex:commandbutton value="Clear" Style="width:45px;" action="{!checkBeforeClear}" status="msg_refresh1" rerender="selectAll,script,SearchResultsSection,AddButton,AddErrors,UpdateErrors,popup,searchButton,ProductStr,BU,spg,results" />
               <apex:actionFunction name="ProdSearch" action="{!Searchproducts}" rerender="results"/> 
          </apex:outputPanel>   
              
         </apex:pageBlockButtons> 
       
    </apex:pageBlock>
    
        <apex:pageMessages id="AddErrors"/>
        
        <apex:outputPanel id="SearchResultsSection">
        
        <apex:pageBlock id="SearchResults" title="Search Results" rendered="{!searchResults.size > 0}">
        
         <apex:pageBlockButtons location="top">
            <apex:outputPanel >
            <apex:commandButton value="Add Product"  id="AddButton" Style="width:90px;" onclick="jsAdd();"  status="msg_refresh1" reRender="selectedProductSection,SearchResultsSection,AddButton,selectedProducts,SearchResults,AddErrors,selectAll" rendered="{!IF($Label.AddProductButton == 'First',true,false)}"/>
            <apex:commandButton value="Add Product2"  id="AddButton2" Style="width:90px;" action="{!addProduct2}"  status="msg_refresh1" reRender="AddErrors,selectedProductSection"  oncomplete="AddEligibleStatus();" rendered="{!IF($Label.AddProductButton == 'Second',true,false)}"/>  
             </apex:outputPanel>
        </apex:pageBlockButtons>
        
        
     
        
        
        
            <apex:pageblocktable value="{!searchResults}" var="Product" id="results">
            
                <apex:column >
                    <apex:facet name="header">
                        <apex:inputCheckbox value="{!mainSelect}" onclick="selectAllProducts(this,'chk1')" id="selectAll" />
                     </apex:facet>
                        <apex:inputCheckbox value="{!Product.Selected}" id="chk1" />
                     </apex:column>
                        
                <apex:column headerValue="Product Name"  value="{!Product.productName}">
                    
                </apex:column>
                
                <apex:column headerValue="Business Unit" value="{!Product.businessUnit}">
                </apex:column>
            
                <apex:column headerValue="Business Type" >
                 <apex:outputPanel styleClass="requiredInput" layout="block">
                 <apex:outputPanel styleClass="requiredBlock" layout="block"/>
                    <apex:selectList value="{!Product.businessType}" id="bustype1" size="1" required="true">   
                        <apex:selectOptions value="{!selbustype}"/>
                    </apex:selectList>
                </apex:outputPanel>
                
                </apex:column>
            
                <apex:column headerValue="Sales Price">
                 <apex:outputPanel styleClass="requiredInput" layout="block" >
                 <apex:outputPanel styleClass="requiredBlock" layout="block"/>
                        <apex:inputfield value="{!Product.oppline.UnitPrice}"   />
                 </apex:outputPanel>
                                 
                </apex:column>
            
                 <apex:column headerValue="Term (Month)">
                  <apex:outputPanel styleClass="requiredInput" layout="block" >
                    <apex:outputPanel styleClass="requiredBlock" layout="block"/>
                
                        <apex:inputfield value="{!Product.oppline.Term_Month__c }"  />
                  </apex:outputPanel>
                 
                </apex:column>
                
            </apex:pageblocktable>
          </apex:pageBlock>
          </apex:outputPanel>
 <apex:pageMessages id="UpdateErrors"/>
    
   <apex:outputPanel id="selectedProductSection">
    
        <apex:pageBlock title="Selected Products" id="selectedProducts" rendered="{!selectedProducts.size>0}">
        
         
        
          <apex:pageBlockButtons location="top">
        
            <apex:commandButton value="Update Product" Style="width:90px;" action="{!saveDeal}"  status="msg_refresh1" reRender="selectedProducts,SearchResults,UpdateErrors"/>
            
        </apex:pageBlockButtons>
         
        <div style="overflow: scroll;  height: 210px;"> 
             <apex:pageblocktable value="{!selectedProducts}" var="Product" >
           
                <apex:column >
                   <apex:commandLink value="Del" action="{!checkBeforeDelete}" reRender="delpopup" status="msg_refresh1">
                    <apex:param name="deletedProduct" value="{!Product.productName}" />
                    
                   </apex:commandLink>
                </apex:column>
                        
                <apex:column headerValue="Product Name"  value="{!Product.productName}">
                </apex:column>
                
                <apex:column headerValue="Business Unit" value="{!Product.businessUnit}">
                </apex:column>
            
                <apex:column headerValue="Business Type" >
                  <apex:outputPanel styleClass="requiredInput" layout="block">
                  <apex:outputPanel styleClass="requiredBlock" layout="block"/>                
                  <apex:selectList value="{!Product.BusinessType}" id="bustype2" size="1" required="true">   
                        <apex:selectOptions value="{!selbustype}"/>
                  </apex:selectList>
                  </apex:outputPanel> 
                </apex:column>
            
                <apex:column headerValue="Sales Price">
                <apex:outputPanel styleClass="requiredInput" layout="block">
                 <apex:outputPanel styleClass="requiredBlock" layout="block"/>
                        <apex:inputfield value="{!Product.oppline.UnitPrice}"   />
                 </apex:outputPanel>
                
                </apex:column>
            
                <apex:column headerValue="Term (Month)">
                <apex:outputPanel styleClass="requiredInput" layout="block">
                 <apex:outputPanel styleClass="requiredBlock" layout="block"/>
                        <apex:inputfield value="{!Product.oppline.Term_Month__c }"   />
                 </apex:outputPanel>
                </apex:column> 
                
                <!-- <apex:column headerValue="Deal Program Status">
                <apex:outputfield value="{!Product.oppline.Deal_Program_Eligibility_Status__c}"  />
               </apex:column> 
                 <apex:column headerValue="Deal Program ID">
                <apex:outputfield value="{!Product.oppline.Deal_Program_ID__c}"  />
               </apex:column>
               
               <apex:column headerValue="{!$Label.DRDeal_ProgramName}">
                <apex:outputfield value="{!Product.oppline.Deal_Program_Name__c}"  />
               </apex:column>--->
                
                
                <apex:column >
                    <apex:facet name="header">
                    <apex:outputPanel >
                        <apex:outputText value="Deal Registration? "/>
                        <img src="/s.gif" class="helpOrb" title="{!$ObjectType.OpportunityLineItem.Fields.Deal_Registration__c.inlineHelpText}" />
                    </apex:outputPanel>
                    </apex:facet>
 
                <apex:inputfield value="{!Product.oppline.Deal_Registration__c}"   rendered="{!OR(Product.oppline.Deal_Program_Eligibility_Status__c=='Eligible',AND(Product.oppline.Deal_Program_Eligibility_Status__c=='Opt Out',Product.oppline.Deal_Program_Name__c==dealprogramName))}">
                <apex:actionSupport event="onchange" action="{!dealEligibleStatusChange}" rerender="selectedProducts" status="msg_refresh1">
                
                </apex:actionSupport></apex:inputfield>
                <apex:outputfield value="{!Product.oppline.Deal_Registration__c}"  rendered="{!AND(Product.oppline.Deal_Program_Eligibility_Status__c!='Eligible',OR(Product.oppline.Deal_Program_Name__c!=dealprogramName,Product.oppline.Deal_Program_Name__c==null))}"/>
             
               </apex:column>
                
            </apex:pageblocktable>
        </div>    
        </apex:pageBlock>
        </apex:outputPanel>
        
         
</apex:outputPanel>
       
       <apex:outputPanel id="popup" >
        <apex:outputPanel styleClass="customPopup1" rendered="{!notsaved}">
            <apex:outputPanel styleClass="customPopup" layout="block" rendered="{!notsaved}" >
            <br/><br/>
            <center> 
            <b><h1>{!$Label.DRProductSelection}</h1></b><br/><br/><br/><br/>
                    <apex:commandButton value="Yes" action="{!continueClear}" rerender="popup,selectAll,script,SearchResultsSection,AddButton,AddErrors,UpdateErrors,searchButton,ProductStr,BU,spg,results" rendered="{!clearFlag}"/>
                    <apex:commandButton value="Yes" action="{!Searchproducts}"  rerender="popup,SearchResultsSection,AddButton,SearchResults,selectAll" rendered="{!SearchBUFlag}"/>
                    <apex:commandButton value="Yes" action="{!refreshProductTable}"  rerender="popup,script,BU,SearchResultsSection,AddButton,SearchResults,selectAll" rendered="{!SearchTypeAheadFlag}"/>
                    <apex:commandButton value="Yes" action="{!searchByProductGroup}"  rerender="popup,script,spg,BU,ProductStr,SearchErrors,searchButtonpopup,SearchResultsSection,AddButton,SearchResults,selectAll" rendered="{!SearchPGFlag}"/>&nbsp;&nbsp;&nbsp;
                    <apex:commandButton value="Cancel" action="{!closePopup}"  rerender="popup"/>
                    </center> 
            </apex:outputPanel> 
        </apex:outputPanel> 
   </apex:outputPanel> 
   
    
   
     <apex:outputPanel id="delpopup" >
        <apex:outputPanel styleClass="customPopup1" rendered="{!deleteFlag}">
            <apex:outputPanel styleClass="customPopup" layout="block"  rendered="{!deleteFlag}">
            <br/><br/>
            <center> 
            <b><h1>{!$Label.DRDeleteproduct}                  
             </h1></b><br/><br/><br/><br/>
                    <apex:commandButton value="Delete" action="{!deleteProducts}"  rerender="delpopup,selectedProductSection,selectedProducts,UpdateErrors" status="msg_refresh1"/>
                    <apex:commandButton value="Cancel" action="{!closePopup}"  rerender="delpopup"/>
                    </center> 
            
            </apex:outputPanel> 
        </apex:outputPanel> 
    </apex:outputPanel>  
    
        <!-- All pop up contents -->
        <apex:actionFunction name="AddProductFunction" action="{!addAndStay}" status="msg_refresh1"  reRender="selectedProductSection,SearchResultsSection,AddButton,selectedProducts,SearchResults,AddErrors,selectAll" />
        <apex:actionFunction action="{!redirectToDetailPage}" name="goToDetailPage" />
        <apex:actionFunction name="AddEligibleStatus" action="{!progForEachProdCall}" rerender="selectedProductSection,SearchResultsSection,AddButton,selectedProducts,SearchResults,selectAll" status="msg_refresh1"/>
        <apex:actionFunction action="{!checkBeforeReturn}" name="CheckandReturn" onComplete="checkTest();" rerender="updateCheck">
            <apex:param name="unSavedData" assignTo="{!unSavedData}" value="" />
        </apex:actionFunction>
        
        <apex:outputPanel id="updateCheck">
            <script type="text/javascript">
               function checkTest(){
                  if('{!unSavedData}' == 'true'){
                     $("#CheckforUnsavedData").dialog("open");
                  }
                  else{
                    //alert('isPerOpp:'+{!isPerOpp} + 'approvalStatus:'+'{!approvalStatus}');
                    if( !('{!isPerOpp}' == 'true' || '{!approvalStatus}' == 'true') ){
                        openPopUp();
                    }else{
                        goToDetailPage();
                    }
                  }               
               }            
            </script>
        </apex:outputPanel>
        
        
        <div id="noPgmPopup">
            <p> {!$Label.DRNodealregprograms1} </p>
            <p> {!$Label.DRNodealregprograms2} </p>
            <p> {!$Label.DRNodealregprograms3} </p>
        </div>    
        <div id="sepPgmPopup">
            <p> {!$Label.DRDifferentdealregprogram} </p>
            <div id="sepPgmList"></div>
        </div>
        <!-- 
        <div id="popupContent2">
            <p> {!$Label.DRRegisterThisAsDeal} </p>
        </div>
        <div id="popupContent3">
            <p> {!$Label.DRdealsubmitforapproval}</p>
        </div> -->
         <div id="CheckforUnsavedData">
            <p> {!$Label.DRSaveAlert}</p>
            <p> {!$Label.DRSaveAlert2}</p>
        </div>        
  
        
     
    </apex:form>
    

</apex:page>